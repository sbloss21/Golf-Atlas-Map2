<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Golf Atlas Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  html,body,#map{height:100%;margin:0;background:#052D1F;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}

  /* ==== Controls stacked under zoom buttons ==== */
  .control-bar{
    position:absolute;z-index:9999;top:90px;left:12px;
    display:flex;flex-direction:column;align-items:flex-start;gap:10px;
  }
  .control{
    display:flex;gap:8px;align-items:center;
    background:rgba(8,52,36,.92);color:#e9f4ef;border:1px solid rgba(0,0,0,.35);
    border-radius:12px;padding:8px 10px;font:600 13px/1 system-ui;
    box-shadow:0 8px 18px rgba(0,0,0,.35);
  }
  .control input[type="checkbox"]{accent-color:#dcb247;width:18px;height:18px;cursor:pointer}

  /* ==== Search Bar with Clear Button ==== */
  .search{
    display:flex;align-items:center;gap:8px;
    background:rgba(8,52,36,.92);color:#e9f4ef;border:1px solid rgba(0,0,0,.35);
    border-radius:12px;padding:6px 10px;box-shadow:0 8px 18px rgba(0,0,0,.35);
    width:400px;max-width:400px;position:relative;
  }
  .search input{
    flex:1;border:none;outline:none;background:transparent;
    color:#e9f4ef;font:600 14px/1.2 system-ui;
  }
  .search input::placeholder{color:#b6d1c7}
  .search button.clear{
    position:absolute;right:10px;top:50%;transform:translateY(-50%);
    background:none;border:none;color:#b6d1c7;font-size:18px;cursor:pointer;
    display:none;
  }
  .search.has-text button.clear{display:block;}

  /* ==== Cluster styling ==== */
  .marker-cluster div{
    position:relative;display:grid;place-items:center;border-radius:50%;
    width:56px;height:56px;border:2px solid #222;
    background:
      url("data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><defs><radialGradient id='g'><stop offset='0%' stop-color='%23fff'/><stop offset='100%' stop-color='%23ccc'/></radialGradient></defs><rect width='64' height='64' fill='url(%23g)'/></svg>") no-repeat center/cover;
    box-shadow:0 6px 14px rgba(0,0,0,.35);
  }
  .marker-cluster span{font:800 16px system-ui;color:#111;}

  /* ==== Popup (forest green) ==== */
  .leaflet-popup-content-wrapper{background:#052D1F;color:#f2f6f3;border:1px solid rgba(0,0,0,.35);border-radius:16px;}
  .leaflet-popup-tip{background:#052D1F;}
  .popup{min-width:260px;max-width:380px;}
  .popup .line{margin:6px 0;}
  .actions{margin-top:12px;display:flex;justify-content:flex-end;}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#083424;color:#fff;text-decoration:none;font-weight:700;}
  .btn:hover{filter:brightness(1.1);}

  /* ==== Logo / Thumbnail ==== */
  .thumb{width:100%;aspect-ratio:16/9;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.1);margin-bottom:8px;}
  .thumb img{width:100%;height:100%;object-fit:contain;background:#0c1f18;}

  /* ==== Gold Top-100 Badge ==== */
  .badge-top100{
    display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
    background:linear-gradient(145deg,#f7d776,#dcb247 55%,#b9902d);
    color:#111;font-weight:800;box-shadow:0 0 0 1px rgba(255,255,255,.25) inset,0 2px 6px rgba(0,0,0,.4);
  }
  .badge-top100 .rank{background:rgba(255,255,255,.4);padding:3px 6px;border-radius:6px;}

  .ga-tooltip{background:#083424;color:#f1f6f3;border:1px solid rgba(255,255,255,.15);
    border-radius:8px;padding:4px 8px;font-weight:700;}
</style>
</head>
<body>
<div id="map"></div>

<div class="control-bar">
  <div class="search" id="searchWrapper">
    <span>üîé</span>
    <input id="searchBox" list="courseList" placeholder="Search course, city, or state‚Ä¶">
    <button class="clear" id="clearSearch">&times;</button>
    <datalist id="courseList"></datalist>
  </div>
  <div class="control">
    <input type="checkbox" id="top100Toggle">
    <label for="top100Toggle">Show Top-100 Only</label>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>
const params=new URLSearchParams(window.location.search);
const CSV_URL=params.get("csv")||"https://docs.google.com/spreadsheets/d/e/2PACX-1vT-nZvG7m9sUkOu0spxVTVGcM311qlgGSjnFgRDQr-l6nfs1cPFNrGBXO0ZDzMIQg/pub?gid=1171293634&single=true&output=csv";

const map=L.map("map",{center:[37.5,-105],zoom:4.1,minZoom:3.5,maxZoom:14,scrollWheelZoom:true});
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(map);

const clusterLayer=L.markerClusterGroup({showCoverageOnHover:false,maxClusterRadius:48,
  iconCreateFunction:c=>{
    const n=c.getChildCount();
    return L.divIcon({html:`<div><span>${n}</span></div>`,className:"marker-cluster",iconSize:L.point(56,56)});
  }
});
map.addLayer(clusterLayer);

const pinSvg=`<svg xmlns='http://www.w3.org/2000/svg' width='42' height='46' viewBox='0 0 42 46'>
<path d='M21 1c-9.4 0-17 7.6-17 17 0 11 17 27 17 27s17-16 17-27c0-9.4-7.6-17-17-17z' fill="#1f7a3b" stroke="#0e4820" stroke-width="2"/>
<circle cx="21" cy="18" r="8.5" fill="#e8ffe8" stroke="#0e4820" stroke-width="2"/>
<rect x="20.3" y="7" width="1.4" height="14" fill="#2b2b2b"/>
<path d="M21.7 8 L33 12.5 L21.7 17 Z" fill="#c7222a" stroke="#8c141a" stroke-width="1"/>
</svg>`;
const courseIcon=L.icon({iconUrl:"data:image/svg+xml,"+encodeURIComponent(pinSvg),iconSize:[42,46],iconAnchor:[21,42]});

const esc=s=>String(s??"").replace(/[&<>]/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[s]));
const isTop100=v=>!isNaN(v)&&v>0&&v<=100;
const safeUrl=u=>/^https?:/i.test(u||"")?u:"";

function makePopup(r){
  const name=r["course_name"]||r["Course Name"];
  const resort=r["course_resort"]||"";
  const fees=r["cost_per_course(green_fee_range)"]||"";
  const rank=r["top_100_ranking"]||"";
  const lodging=r["lodging_on-site(yes_no)"]||"";
  const city=r["City"]||""; const state=r["State"]||"";
  const logo=safeUrl(r["logo_url(linked)"]||r["logo_url"]||"");
  const thumb=safeUrl(r["thumbnail_url(linked)"]||r["thumbnail_url"]||"");
  const img=thumb||logo;
  const html=`<div class="popup">
    ${img?`<div class="thumb"><img src="${img}" alt=""></div>`:""}
    ${isTop100(rank)?`<div class="badge-top100">Top 100 <span class="rank">#${rank}</span></div>`:""}
    <div class="line"><b>üèåÔ∏è‚Äç‚ôÇÔ∏è ${esc(name)}</b></div>
    ${resort?`<div class="line">üè® ${esc(resort)}</div>`:""}
    ${fees?`<div class="line">üí∞ ${esc(fees)}</div>`:""}
    ${lodging?`<div class="line">üõèÔ∏è Lodging: ${esc(lodging)}</div>`:""}
    ${city?`<div class="line">üìç ${esc(city)}, ${esc(state)}</div>`:""}
    <div class="actions"><a class="btn" href="https://www.google.com/search?q=${encodeURIComponent(name+' golf')}" target="_blank">View Course ‚Üó</a></div>
  </div>`;
  return html;
}

let markers=[],filteredMarkers=[];
Papa.parse(CSV_URL,{
  download:true,header:true,skipEmptyLines:true,
  complete:res=>{
    res.data.forEach(r=>{
      const lat=+r.latitude||+r.Latitude,lon=+r.longitude||+r.Longitude;
      if(!lat||!lon)return;
      const m=L.marker([lat,lon],{icon:courseIcon,title:r["course_name"]||""});
      m.bindPopup(makePopup(r),{maxWidth:380});
      clusterLayer.addLayer(m);
      markers.push({m,r});
    });
  }
});

function applyFilters(){
  const q=document.getElementById("searchBox").value.toLowerCase();
  const topOnly=document.getElementById("top100Toggle").checked;
  clusterLayer.clearLayers();
  filteredMarkers=[];
  markers.forEach(({m,r})=>{
    const rank=r["top_100_ranking"];
    const text=(r["course_name"]+" "+r["City"]+" "+r["State"]).toLowerCase();
    if((!q||text.includes(q))&&(!topOnly||isTop100(rank))){
      clusterLayer.addLayer(m);filteredMarkers.push({m,r});
    }
  });
}
document.getElementById("top100Toggle").onchange=applyFilters;
const searchBox=document.getElementById("searchBox");
const clearBtn=document.getElementById("clearSearch");
searchBox.oninput=()=>{applyFilters();document.getElementById("searchWrapper").classList.toggle("has-text",!!searchBox.value);}
clearBtn.onclick=()=>{searchBox.value="";applyFilters();document.getElementById("searchWrapper").classList.remove("has-text");}
</script>
</body>
</html>
