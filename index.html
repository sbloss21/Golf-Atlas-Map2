<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golf Atlas Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100%; }

    /* ===== Dark popup style (emerald/charcoal) ===== */
    .leaflet-popup-content-wrapper{
      background:#0f1916;                /* deep green-black */
      color:#e7f2ee;                      /* soft mint text */
      border-radius:14px;
      box-shadow:0 14px 36px rgba(0,0,0,.35);
      border:1px solid rgba(209,190,107,.25); /* faint gold edge */
    }
    .leaflet-popup-tip{ background:#0f1916; border:1px solid rgba(209,190,107,.25); }
    .ga-popup{ font: 500 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .ga-popup .title{
      font-size:16px; font-weight:800; letter-spacing:.2px; margin:0 0 6px;
      color:#f6fff9;
    }
    .ga-popup .line{ margin:2px 0; }
    .ga-popup a{
      color:#d1be6b; text-decoration:none; border-bottom:1px dotted rgba(209,190,107,.55);
    }
    .ga-popup a:hover{ opacity:.85; }

    /* Cluster shadow tweak */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large{
      box-shadow:0 2px 8px rgba(0,0,0,.25);
    }
  </style>
</head>
<body>
  <div id="map" aria-label="Golf Atlas map"></div>

  <!-- JS libs -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /*** 1) MAP (tight on the lower 48) ***/
    const CONUS_BOUNDS = L.latLngBounds(
      [24.396308, -124.848974], // SW
      [49.384358,  -66.885444]  // NE
    );

    const map = L.map('map', {
      zoomControl: true,
      minZoom: 3,
      maxZoom: 18,
      worldCopyJump: true
    });

    // Light tiles so dark popups pop
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // Initial view = lower 48
    map.fitBounds(CONUS_BOUNDS, { padding:[20,20] });

    // Keep users roughly on North America (prevents zooming way out for HI)
    map.setMaxBounds(L.latLngBounds([10, -170], [72, -50]));
    map.options.maxBoundsViscosity = 0.6;

    // Cluster group
    const cluster = L.markerClusterGroup({
      showCoverageOnHover:false,
      spiderfyOnMaxZoom:true,
      maxClusterRadius:45
    }).addTo(map);

    // Group we use ONLY to fit after load (excludes HI/AK)
    const conusGroup = L.featureGroup();

    /*** 2) CSV LOADER ***/
    function csvUrlFromQuery(){
      try{
        const u = new URL(window.location.href);
        return u.searchParams.get('csv') || '';
      }catch(e){ return ''; }
    }

    function makePopupHTML(r){
      const name = r.course_name || r.name || 'Course';
      const city = r.city ? r.city : '';
      const state = r.state || r.region || '';
      const fee  = (r['cost_per_course(green_fee_range_)'] || r.cost_per_course || r.green_fee_range || '').toString().trim();
      const site = r.website || r.url || '';

      // Emojis: ‚õ≥Ô∏è name, üìç location, üíµ fee, üåê website
      return `
        <div class="ga-popup">
          <div class="title">‚õ≥Ô∏è ${name}</div>
          <div class="line">üìç ${city ? city + ', ' : ''}${state}</div>
          ${fee ? `<div class="line">üíµ ${fee}</div>` : ''}
          ${site ? `<div class="line">üåê <a href="${site}" target="_blank" rel="noopener">Website</a></div>` : ''}
        </div>
      `;
    }

    function addRowAsMarker(r){
      const lat = parseFloat(r.lat || r.latitude);
      const lng = parseFloat(r.lng || r.longitude || r.lon);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return;

      const m = L.marker([lat, lng]).bindPopup(makePopupHTML(r), { maxWidth: 260 });
      cluster.addLayer(m);

      const state = (r.state || r.region || '').toUpperCase();
      if (state !== 'HI' && state !== 'AK') conusGroup.addLayer(m);
    }

    function loadCSV(url){
      if(!url){
        // No CSV provided‚Äîsample pins so page isn't empty
        [
          { course_name:'Pebble Beach', city:'Pebble Beach', state:'CA', lat:36.5678, lng:-121.95, 'cost_per_course(green_fee_range_)':'$595‚Äì625', website:'https://www.pebblebeach.com' },
          { course_name:'Whistling Straits', city:'Sheboygan', state:'WI', lat:43.845, lng:-87.205, 'cost_per_course(green_fee_range_)':'$300‚Äì410', website:'https://www.destinationkohler.com/golf/whistling-straits' },
          { course_name:'Kapalua (Plantation)', city:'Lahaina', state:'HI', lat:20.9969, lng:-156.6530, 'cost_per_course(green_fee_range_)':'$395‚Äì450', website:'https://golfatkapalua.com' }
        ].forEach(addRowAsMarker);

        // Fit to CONUS markers only
        if (conusGroup.getLayers().length) {
          map.fitBounds(conusGroup.getBounds().pad(0.05));
        } else {
          map.fitBounds(CONUS_BOUNDS, { padding:[20,20] });
        }
        return;
      }

      Papa.parse(url, {
        download:true,
        header:true,
        skipEmptyLines:true,
        complete: res => {
          res.data.forEach(addRowAsMarker);

          // Critical: fit to CONUS markers only (prevents zooming out for HI/AK)
          if (conusGroup.getLayers().length) {
            map.fitBounds(conusGroup.getBounds().pad(0.05));
          } else {
            map.fitBounds(CONUS_BOUNDS, { padding:[20,20] });
          }
        },
        error: err => {
          console.error('CSV load error:', err);
          map.fitBounds(CONUS_BOUNDS, { padding:[20,20] });
        }
      });
    }

    loadCSV(csvUrlFromQuery());
  </script>
</body>
</html>
