<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Golf Atlas Map</title>

  <!-- Leaflet core -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    :root{
      --bg:#111716;       /* deep green-black */
      --fg:#f6f6f6;       /* foreground text */
      --accent:#d1be6b;   /* gold accent */
      --ink:#0f1916;      /* dark ink for popups */
      --card:#ffffff;     /* popup bg */
    }
    html, body { height:100%; margin:0; background:var(--bg); color:var(--fg); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; }

    header {
      padding: 18px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .brand { font-weight:800; letter-spacing:.06em; }
    .tag { color:var(--accent); opacity:.9; }

    .wrap { max-width: 1400px; margin: 0 auto; padding: 18px 22px 0; }
    .hero {
      display:grid;
      grid-template-columns: 1.1fr 1.6fr;
      gap:28px;
      align-items:center;
    }
    .hero h1 { font-size: clamp(28px, 5vw, 56px); line-height:1.05; margin:10px 0 4px; }
    .hero p  { font-size: clamp(14px, 2.2vw, 20px); margin: 0; color: var(--accent); }

    .map-wrap {
      position:relative;
      height: 70vh;
      border-radius: 16px;
      overflow:hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      background:#0b0f0e;
    }
    #map { width:100%; height:100%; }

    /* Hawaii inset card */
    #hawaii-inset{
      position:absolute;
      right:16px;
      bottom:16px;
      width:220px;
      height:150px;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      z-index:500;
      border:1px solid rgba(255,255,255,.35);
      background:#0b0f0e;
    }
    #hawaii-inset .leaflet-control-container{ display:none; } /* hide inset controls */

    /* Popup styling (white card, dark text) */
    .leaflet-popup-content-wrapper{
      background:var(--card);
      color:var(--ink);
      border-radius:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
    }
    .leaflet-popup-tip{ background:var(--card); }
    .ga-popup strong{ color:#0e1513; }
    .ga-popup small{ color:#5c6b66; }

    /* Cluster tweak: subtle dropshadow */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large{
      box-shadow:0 2px 8px rgba(0,0,0,.25);
    }

    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
      .map-wrap{ height: 68vh; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">GOLF ATLAS</div>
    <div class="tag">Plan, Explore, Experience</div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div>
        <h1>GOLF ATLAS — YOUR ULTIMATE GOLF TRIP COMPANION</h1>
        <p>Plan, Explore, and Experience the Best Golf Trips</p>
      </div>

      <div class="map-wrap">
        <div id="map" aria-label="Golf Atlas map"></div>
        <div id="hawaii-inset" aria-label="Hawaii inset map"></div>
      </div>
    </section>
  </main>

  <!-- JS libs -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /***** 1) MAP: default to LOWER 48 (CONUS) *****/
    const conusBounds = L.latLngBounds([24.5, -125],[49.5, -66]); // SW, NE
    const map = L.map('map', {
      zoomControl: true,
      minZoom: 3,
      maxZoom: 18,
      worldCopyJump: true
    });

    // Default view is the continental US
    map.fitBounds(conusBounds, { padding:[20,20] });

    // Keep panning roughly on North America
    map.setMaxBounds(L.latLngBounds([10, -170], [72, -50]));

    // Base tiles (swap to your preferred style if needed)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Cluster group for the MAIN map (not used on the inset)
    const cluster = L.markerClusterGroup({
      showCoverageOnHover:false,
      spiderfyOnMaxZoom:true,
      maxClusterRadius: 45
    }).addTo(map);

    /***** 2) HAWAII INSET *****/
    const hiMap = L.map('hawaii-inset', {
      zoomControl:false,
      attributionControl:false,
      dragging:false,
      scrollWheelZoom:false,
      doubleClickZoom:false,
      boxZoom:false,
      touchZoom:false
    }).setView([20.75, -156.2], 7); // around Maui

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(hiMap);

    /***** 3) CSV LOADER *****/
    // Expect ?csv=<public-csv-url> (Google Sheets "Publish to web" CSV works great)
    function getCsvUrl(){
      const u = new URL(window.location.href);
      return u.searchParams.get('csv') || '';
    }

    function parseCurrencyRange(val){
      if(!val) return '';
      return String(val).trim();
    }

    function makePopupHTML(r){
      const name = r.course_name || r.name || 'Course';
      const city = r.city ? r.city : '';
      const state = r.state || r.region || '';
      const fee  = parseCurrencyRange(r['cost_per_course(green_fee_range_)'] || r.cost_per_course || r.green_fee_range);
      const site = r.website || r.url || '';

      return `
        <div class="ga-popup">
          <strong>${name}</strong><br/>
          ${city ? city + ', ' : ''}${state}
          ${fee ? `<br/><small>${fee}</small>` : ''}
          ${site ? `<br/><a href="${site}" target="_blank" rel="noopener">Website</a>` : ''}
        </div>
      `;
    }

    function addRowAsMarker(r){
      const lat = parseFloat(r.lat || r.latitude);
      const lng = parseFloat(r.lng || r.lon || r.longitude);
      if (Number.isNaN(lat) || Number.isNaN(lng)) return;

      const popupHTML = makePopupHTML(r);
      const isHI = ((r.state || r.region || '').toUpperCase() === 'HI');

      if(isHI){
        // Add to the inset
        const m = L.marker([lat, lng]).bindPopup(popupHTML);
        m.addTo(hiMap);
        // Optional: jump the MAIN map to real Hawaii on click
        m.on('click', () => {
          map.flyTo([lat, lng], 8, { duration: 0.8 });
          const ghost = L.marker([lat, lng]).addTo(map).bindPopup(popupHTML);
          ghost.openPopup();
          setTimeout(() => map.removeLayer(ghost), 5000);
        });
      }else{
        // Add to the clustered main map
        const m = L.marker([lat, lng]).bindPopup(popupHTML);
        cluster.addLayer(m);
      }
    }

    function loadCSV(url){
      if(!url){
        console.warn('No CSV URL provided. Add ?csv=<public-csv-url> to the page URL.');
        // Still show a couple sample points so the page isn’t empty
        [
          { course_name:'Pebble Beach', city:'Pebble Beach', state:'CA', lat:36.5678, lng:-121.95, 'cost_per_course(green_fee_range_)':'$595–625', website:'https://www.pebblebeach.com' },
          { course_name:'Kapalua (Plantation)', city:'Lahaina', state:'HI', lat:20.9969, lng:-156.6530, 'cost_per_course(green_fee_range_)':'$395–450' }
        ].forEach(addRowAsMarker);
        return;
      }

      Papa.parse(url, {
        download:true,
        header:true,
        skipEmptyLines:true,
        complete: results => {
          results.data.forEach(addRowAsMarker);
        },
        error: err => {
          console.error('CSV load error:', err);
        }
      });
    }

    loadCSV(getCsvUrl());
  </script>
</body>
</html>
