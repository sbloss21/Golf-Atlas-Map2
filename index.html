<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Golf Atlas Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #f8fafc;
    }

    /* Simple header bar */
    .topbar {
      position: absolute;
      z-index: 1000;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: #ffffff;
      color: #065f46;
      padding: 8px 12px;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      font-weight: 600;
      letter-spacing: 0.2px;
      display: flex;
      gap: 8px;
      align-items: center;
      border: 1px solid #e5e7eb;
    }
    .legend-dot {
      width: 10px; height: 10px; border-radius: 50%; background: #16a34a;
      display: inline-block; vertical-align: middle; margin-right: 6px;
      box-shadow: inset 0 0 0 1px #065f46;
    }

    /* Popups */
    .leaflet-popup-content-wrapper {
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }
    .leaflet-popup-content {
      margin: 10px 12px;
    }
    .popup-title {
      font-weight: 700; font-size: 16px; margin: 0 0 4px;
    }
    .popup-sub {
      color: #065f46; font-weight: 600; margin: 0 0 6px;
    }
    .popup-line { margin: 0 0 4px; color: #334155; }
    .popup-link a {
      text-decoration: none; color: #0f766e; font-weight: 600;
    }
    .popup-link a:hover { text-decoration: underline; }

    /* Custom cluster */
    .ga-cluster-wrapper {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }
    .ga-cluster img {
      display: block;
      width: 100%;
      height: auto;
      pointer-events: none;
    }

    /* Leaflet default marker shadows off (cleaner look) */
    .leaflet-marker-icon, .leaflet-marker-shadow { image-rendering: auto; }
  </style>
</head>
<body>
  <div class="topbar" title="Green flags are courses. Clusters show counts.">
    <span class="legend-dot"></span> Golf Atlas — Courses Map
  </div>
  <div id="map"></div>

  <script>
    // ----------- Helpers -----------
    function getParam(name) {
      const p = new URLSearchParams(location.search).get(name);
      return p ? decodeURIComponent(p) : null;
    }

    function coalesce(obj, keys) {
      for (const k of keys) {
        if (obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "") {
          return obj[k];
        }
      }
      return undefined;
    }

    function toNumber(x) {
      if (x === undefined) return undefined;
      const n = Number(String(x).replace(/[^\d.-]/g, ""));
      return isFinite(n) ? n : undefined;
    }

    // ----------- Map init -----------
    const map = L.map('map', {
      worldCopyJump: true,
      preferCanvas: true
    });

    // Light basemap (Carto Positron)
    const tiles = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
      {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
        maxZoom: 19
      }
    ).addTo(map);

    // Keep view within USA + AK/HI
    const usBounds = L.latLngBounds(
      L.latLng(5, -170),   // SW
      L.latLng(72, -50)    // NE
    );
    map.setMaxBounds(usBounds.pad(0.05));
    map.fitBounds(L.latLngBounds([ [24.5, -125], [49.5, -66.5] ]), { padding: [20,20] });

    // ----------- Icons -----------
    // Golf flag SVG marker
    const flagSVG = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="34" height="46" viewBox="0 0 34 46">
        <defs>
          <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.35"/>
          </filter>
        </defs>
        <g filter="url(#shadow)">
          <rect x="15.5" y="6" width="3" height="32" fill="#6b7280" rx="1.5"/>
          <path d="M17 7 L28 12 L17 17 Z" fill="#16a34a" stroke="#064e3b" stroke-width="1.25"/>
          <ellipse cx="17" cy="40" rx="10" ry="3.5" fill="#86efac" stroke="#16a34a" stroke-width="1"/>
          <circle cx="22.5" cy="38.2" r="1.5" fill="#065f46"/>
        </g>
      </svg>
    `);

    const flagIcon = L.icon({
      iconUrl: `data:image/svg+xml;charset=UTF-8,${flagSVG}`,
      iconSize: [34, 46],
      iconAnchor: [17, 45],
      popupAnchor: [0, -38]
    });

    // Cluster icon (golf ball with count)
    function golfBallClusterIcon(cluster) {
      const count = cluster.getChildCount();
      const size = count < 10 ? 36 : count < 50 ? 42 : count < 200 ? 50 : 58;

      const ballSVG = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 60 60">
          <defs>
            <radialGradient id="ballGrad" cx="40%" cy="30%" r="70%">
              <stop offset="0%" stop-color="#ffffff"/>
              <stop offset="100%" stop-color="#e5e7eb"/>
            </radialGradient>
            <filter id="ballShadow" x="-30%" y="-30%" width="160%" height="160%">
              <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.35"/>
            </filter>
          </defs>
          <g filter="url(#ballShadow)">
            <circle cx="30" cy="30" r="24" fill="url(#ballGrad)" stroke="#d1d5db" stroke-width="1.5"/>
            ${[12,18,24,30,36,42,48].map(y =>
              [18,24,30,36,42].map(x =>
                `<circle cx="${x}" cy="${y}" r="1.4" fill="#d1d5db" opacity="${
                  (y===12||y===48)?0.35:(y===18||y===42)?0.45:(y===24||y===36)?0.55:0.6
                }"/>`
              ).join('')
            ).join('')}
            <text x="30" y="34" text-anchor="middle"
                  font-family="system-ui, -apple-system, Segoe UI, Roboto, sans-serif"
                  font-size="20" font-weight="700" fill="#111827">${count}</text>
          </g>
        </svg>
      `);

      return L.divIcon({
        html: `<div class="ga-cluster"><img src="data:image/svg+xml;charset=UTF-8,${ballSVG}" alt="${count}"/></div>`,
        className: 'ga-cluster-wrapper',
        iconSize: [size, size]
      });
    }

    // ----------- Cluster layer -----------
    const markers = L.markerClusterGroup({
      showCoverageOnHover: false,
      spiderfyOnMaxZoom: true,
      maxClusterRadius: 55,
      iconCreateFunction: golfBallClusterIcon
    });
    map.addLayer(markers);

    // ----------- Load CSV -----------
    const csvUrl = getParam('csv') || '';
    if (!csvUrl) {
      console.warn('No CSV URL provided. Pass ?csv=<public CSV URL>');
    }

    Papa.parse(csvUrl, {
      download: true,
      header: true,
      dynamicTyping: false,
      skipEmptyLines: true,
      complete: function(results) {
        const rows = results.data || [];
        let added = 0;

        rows.forEach((row) => {
          // Try common column names (case-insensitive)
          // Lat/Lng
          const lat = toNumber(coalesce(row, ['lat','Lat','LAT','latitude','Latitude','LATITUDE']));
          const lng = toNumber(coalesce(row, ['lng','Lon','lon','Lng','LON','longitude','Longitude','LONGITUDE']));

          if (lat === undefined || lng === undefined) return; // need coordinates

          // Course name & details
          const name = coalesce(row, ['Name','Course','Course Name','Title','Club','course','name']) || 'Unnamed Course';
          const city = coalesce(row, ['City','city','Town','town']);
          const state = coalesce(row, ['State','state','Province','province','ST']);
          const rank = coalesce(row, ['Rank','rank','Ranking','ranking']);
          const price = coalesce(row, ['Price','price','Green Fee','green_fee','Avg Price']);
          const lodging = coalesce(row, ['Lodging','lodging','On-site Lodging','Onsite Lodging','Onsite','Has Lodging']);
          const url = coalesce(row, ['URL','Url','url','Website','website','Link','link']);

          // Popup HTML
          const lines = [];
          lines.push(`<h3 class="popup-title">${escapeHtml(name)}</h3>`);
          if (city || state) lines.push(`<p class="popup-sub">${escapeHtml([city, state].filter(Boolean).join(', '))}</p>`);
          if (rank) lines.push(`<p class="popup-line"><strong>Rank:</strong> ${escapeHtml(String(rank))}</p>`);
          if (price) lines.push(`<p class="popup-line"><strong>Price:</strong> ${escapeHtml(String(price))}</p>`);
          if (lodging) lines.push(`<p class="popup-line"><strong>Lodging:</strong> ${escapeHtml(String(lodging))}</p>`);
          if (url) lines.push(`<p class="popup-link"><a href="${safeUrl(url)}" target="_blank" rel="noopener">Visit site ↗</a></p>`);

          const m = L.marker([lat, lng], { icon: flagIcon }).bindPopup(lines.join(''));
          markers.addLayer(m);
          added++;
        });

        if (added > 0) {
          try {
            map.fitBounds(markers.getBounds().pad(0.1));
          } catch(e) {
            // fall back to default US view
            map.fitBounds(L.latLngBounds([ [24.5, -125], [49.5, -66.5] ]), { padding: [20,20] });
          }
        } else {
          alert('No valid rows found in the CSV (need Latitude/Longitude columns).');
        }
      },
      error: function(err) {
        console.error('CSV load error:', err);
        alert('There was a problem loading the CSV. Make sure the ?csv= link is public.');
      }
    });

    // ----------- Utilities -----------
    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }
    function safeUrl(u) {
      const s = String(u).trim();
      if (/^https?:\/\//i.test(s)) return s;
      return 'https://' + s.replace(/^\/+/, '');
    }
  </script>
</body>
</html>
