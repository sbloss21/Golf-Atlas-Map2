<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golf Atlas Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <!-- MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    html, body { height:100%; margin:0; }
    #map { width:100%; height:100%; }

    /* ===== Dark popup style (emerald/charcoal) ===== */
    .leaflet-popup-content-wrapper{
      background:#0f1916;                /* deep green-black */
      color:#e7f2ee;                      /* soft mint text */
      border-radius:14px;
      box-shadow:0 14px 36px rgba(0,0,0,.35);
      border:1px solid rgba(209,190,107,.25); /* faint gold edge */
    }
    .leaflet-popup-tip{ background:#0f1916; border:1px solid rgba(209,190,107,.25); }
    .ga-popup{ font: 500 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .ga-popup .title{
      font-size:16px; font-weight:800; letter-spacing:.2px; margin:0 0 6px;
      color:#f6fff9;
    }
    .ga-popup .row { margin:2px 0; display:flex; gap:6px; align-items:flex-start; }
    .ga-popup .label { opacity:.9; }
    .ga-popup a{
      color:#d1be6b; text-decoration:none; border-bottom:1px dotted rgba(209,190,107,.55);
    }
    .ga-popup a:hover{ opacity:.85; }

    /* ===== Custom cluster icon: golf ball with count ===== */
    .ga-cluster {
      background: radial-gradient(ellipse at 35% 30%, #ffffff 0%, #f0f0f0 60%, #e1e1e1 100%);
      border: 2px solid #c9c9c9;
      border-radius: 50%;
      width: 44px; height: 44px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,.25), inset 0 2px 6px rgba(0,0,0,.12);
      position: relative;
      font-weight: 800; color:#0b0f0e;
    }
    .ga-cluster::after {
      content: "";
      position: absolute;
      top: 8px; left: 12px;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: rgba(0,0,0,.08);
      box-shadow:
        10px 2px 0 rgba(0,0,0,.07),
        18px 6px 0 rgba(0,0,0,.06),
        6px 14px 0 rgba(0,0,0,.05),
        16px 16px 0 rgba(0,0,0,.06),
        2px 20px 0 rgba(0,0,0,.07);
      filter: blur(.2px);
    }

    /* Remove default cluster bg */
    .marker-cluster div { background: transparent; border: none; }

  </style>
</head>
<body>
  <div id="map" aria-label="Golf Atlas map"></div>

  <!-- JS libs -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /*** 0) CONFIG ***/
    const SHOW_HI_NEAR_CA = true;  // draw HI off California (overview)
    const CONUS_BOUNDS = L.latLngBounds(
      [24.396308, -124.848974], // SW
      [49.384358,  -66.885444]  // NE
    );

    // Simple visual offset to place Hawaii off California in overview.
    // You can tweak these delta values to reposition the block.
    function relocateHawaii(lat, lng){
      // Move roughly 13¬∞ north and 35¬∞ east ‚âà off NorCal
      return [lat + 13, lng + 35];
    }

    /*** 1) MAP (tight on the lower 48) ***/
    const map = L.map('map', {
      zoomControl: true,
      minZoom: 3,
      maxZoom: 18,
      worldCopyJump: true
    });

    // Light tiles so dark popups pop
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // Initial view = lower 48
    map.fitBounds(CONUS_BOUNDS, { padding:[20,20] });

    // Keep users roughly on North America
    map.setMaxBounds(L.latLngBounds([10, -170], [72, -50]));
    map.options.maxBoundsViscosity = 0.6;

    /*** 2) Icons (flag pin for markers, golf ball for clusters) ***/
    // Flag pin (SVG data URL so you don‚Äôt need external files)
    const FLAG_PIN_URL = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
      <svg width="36" height="48" viewBox="0 0 36 48" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="s" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="rgba(0,0,0,.35)"/>
          </filter>
        </defs>
        <path d="M18 48c-4-8-12-15-12-24C6 11 11 6 18 6s12 5 12 18c0 9-8 16-12 24z" fill="#0f1916" filter="url(#s)"/>
        <circle cx="18" cy="18" r="10" fill="#162521" stroke="#d1be6b" stroke-width="1.5"/>
        <path d="M12 21h10" stroke="#d1be6b" stroke-width="2" stroke-linecap="round"/>
        <path d="M18 11v10" stroke="#d1be6b" stroke-width="2" stroke-linecap="round"/>
        <path d="M19 14l0 -6" stroke="#d1be6b" stroke-width="1.5"/>
        <path d="M19 8l8 3l-8 3z" fill="#d1be6b"/>
      </svg>
    `);

    const flagIcon = L.icon({
      iconUrl: FLAG_PIN_URL,
      iconSize: [36, 48],
      iconAnchor: [18, 44],
      popupAnchor: [0, -40],
      tooltipAnchor: [0, -40]
    });

    // Cluster group with custom "golf ball" icon + count
    const cluster = L.markerClusterGroup({
      showCoverageOnHover:false,
      spiderfyOnMaxZoom:true,
      maxClusterRadius:45,
      iconCreateFunction: (cluster) => {
        const count = cluster.getChildCount();
        return L.divIcon({
          html: `<div class="ga-cluster">${count}</div>`,
          className: '',  // we provide full HTML/CSS
          iconSize: [44,44]
        });
      }
    }).addTo(map);

    // Group we use ONLY to fit after load (excludes AK; includes HI relocated)
    const conusGroup = L.featureGroup();

    /*** 3) CSV LOADER ***/
    function csvUrlFromQuery(){
      try{
        const u = new URL(window.location.href);
        return u.searchParams.get('csv') || '';
      }catch(e){ return ''; }
    }

    // Build the dark, emoji popup with the ‚Äúvital info‚Äù
    function makePopupHTML(r, {isRelocatedHI=false} = {}){
      const name = r.course_name || r.name || 'Course';
      const city = r.city ? r.city : '';
      const state = (r.state || r.region || '').toUpperCase();

      const top100 = (r.top_100_ranking || r.top100 || '').toString().trim();
      const par    = (r.par || '').toString().trim();
      const yards  = (r['yardage(black_tees)'] || r.yardage || r.yards || '').toString().trim();
      const arch   = (r.architect || '').toString().trim();

      const fee    = (r['cost_per_course(green_fee_range_)'] || r.cost_per_course || r.green_fee_range || '').toString().trim();
      const lodgeY = (r['lodging_on-site(yes_no)'] || r.lodging_on_site || r.lodging || '').toString().trim();
      const lodgeD = (r.lodging_details || '').toString().trim();
      const season = (r['peak_season/best_time_to_visit'] || r.peak_season || r.best_time || '').toString().trim();
      const site   = r.website || r.url || '';

      return `
        <div class="ga-popup">
          <div class="title">‚õ≥Ô∏è ${name}</div>
          <div class="row">üìç <span class="label">${city ? city + ', ' : ''}${state}${isRelocatedHI ? ' ‚Ä¢ (HI ‚Äì overview)' : ''}</span></div>
          ${top100 ? `<div class="row">üèÜ <span class="label">Top 100:</span> ${top100}</div>` : ''}
          ${par    ? `<div class="row">üßÆ <span class="label">Par:</span> ${par}</div>` : ''}
          ${yards  ? `<div class="row">üìè <span class="label">Yardage:</span> ${yards}</div>` : ''}
          ${arch   ? `<div class="row">üõ†Ô∏è <span class="label">Architect:</span> ${arch}</div>` : ''}
          ${fee    ? `<div class="row">üíµ <span class="label">Fees:</span> ${fee}</div>` : ''}
          ${lodgeY ? `<div class="row">üè® <span class="label">Lodging:</span> ${lodgeY}${lodgeD ? ` ‚Äî ${lodgeD}` : ''}</div>` : (lodgeD ? `<div class="row">üè® <span class="label">Lodging:</span> ${lodgeD}</div>` : '')}
          ${season ? `<div class="row">üóìÔ∏è <span class="label">Best time:</span> ${season}</div>` : ''}
          ${site   ? `<div class="row">üåê <a href="${site}" target="_blank" rel="noopener">Website</a></div>` : ''}
          ${isRelocatedHI ? `<div class="row">‚úàÔ∏è <a href="#" class="ga-jump-hi">Jump to real Hawaii location</a></div>` : ''}
        </div>
      `;
    }

    // Create the marker (handles HI relocation & ‚Äújump to real‚Äù)
    function addRowAsMarker(r){
      const rawLat = parseFloat(r.lat || r.latitude);
      const rawLng = parseFloat(r.lng || r.longitude || r.lon);
      if (Number.isNaN(rawLat) || Number.isNaN(rawLng)) return;

      const state = (r.state || r.region || '').toUpperCase();
      let drawLat = rawLat, drawLng = rawLng, isRelocatedHI = false;

      if (SHOW_HI_NEAR_CA && state === 'HI'){
        const [rlat, rlng] = relocateHawaii(rawLat, rawLng);
        drawLat = rlat; drawLng = rlng;
        isRelocatedHI = true;
      }

      const marker = L.marker([drawLat, drawLng], { icon: flagIcon })
        .bindPopup(makePopupHTML(r, {isRelocatedHI}), { maxWidth: 300 });

      cluster.addLayer(marker);

      // Use for bounds fitting (exclude AK; include HI relocated)
      if (state !== 'AK') conusGroup.addLayer(marker);

      if (isRelocatedHI){
        marker.on('popupopen', () => {
          const a = document.querySelector('.ga-jump-hi');
          if (a){
            a.onclick = (e) => {
              e.preventDefault();
              map.flyTo([rawLat, rawLng], 8, { duration: 0.8 });
            };
          }
        });
      }
    }

    /*** 4) CSV load + fit ***/
    function loadCSV(url){
      if(!url){
        // Samples if no CSV provided
        [
          { course_name:'Pebble Beach', city:'Pebble Beach', state:'CA', lat:36.5678, lng:-121.95,
            'cost_per_course(green_fee_range_)':'$595‚Äì625', website:'https://www.pebblebeach.com',
            par:'72', 'yardage(black_tees)':'6828', architect:'Jack Neville & Douglas Grant' },
          { course_name:'Kapalua (Plantation)', city:'Lahaina', state:'HI', lat:20.9969, lng:-156.6530,
            'cost_per_course(green_fee_range_)':'$395‚Äì450', website:'https://golfatkapalua.com',
            par:'73', 'yardage(black_tees)':'7596', architect:'Bill Coore & Ben Crenshaw', top_100_ranking:'Yes' }
        ].forEach(addRowAsMarker);

        // Fit to all non-AK markers (HI is already relocated into the view)
        if (conusGroup.getLayers().length) {
          map.fitBounds(conusGroup.getBounds().pad(0.05));
        } else {
          map.fitBounds(CONUS_BOUNDS, { padding:[20,20] });
        }
        return;
      }

      Papa.parse(url, {
        download:true,
        header:true,
        skipEmptyLines:true,
        complete: res => {
          res.data.forEach(addRowAsMarker);

          // Critical: fit to non-AK group (HI is in view via relocation)
          if (conusGroup.getLayers().length) {
            map.fitBounds(conusGroup.getBounds().pad(0.05));
          } else {
            map.fitBounds(CONUS_BOUNDS, { padding:[20,20] });
          }
        },
        error: err => {
          console.error('CSV load error:', err);
          map.fitBounds(CONUS_BOUNDS, { padding:[20,20] });
        }
      });
    }

    function csvUrlFromQuery(){
      try{
        const u = new URL(window.location.href);
        return u.searchParams.get('csv') || '';
      }catch(e){ return ''; }
    }

    loadCSV(csvUrlFromQuery());
  </script>
</body>
</html>
