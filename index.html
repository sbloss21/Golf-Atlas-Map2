<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Golf Atlas – Courses</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet core -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- MarkerCluster plugin -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Papa Parse (CSV) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --font: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; }
    html, body { height: 100%; margin: 0; }
    body { font-family: var(--font); }
    #map { height: calc(100vh - 64px); width: 100%; }
    .titlebar {
      padding: 10px 12px;
      display: flex; align-items: baseline; gap: 10px; flex-wrap: wrap;
      border-bottom: 1px solid #eee;
    }
    .titlebar h1 { margin: 0; font-size: 18px; font-weight: 700; }
    .titlebar small { color: #666; }

    /* Popup polish */
    .leaflet-popup-content { margin: 10px 14px; }
    .leaflet-popup-content-wrapper { border-radius: 12px; }
  </style>
</head>
<body>
  <div class="titlebar">
    <h1>Golf Atlas – Courses</h1>
    <small>Provide your data with <code>?csv=ENCODED_CSV_URL</code></small>
  </div>
  <div id="map"></div>

  <script>
    // -------- Helpers --------
    const getParam = (k) => new URL(location.href).searchParams.get(k);
    const val = (x) => (x ?? "").toString().trim();
    const num = (x) => (typeof x === "number" ? x : Number(x));

    // Map + tiles
    const map = L.map("map", { scrollWheelZoom: true });
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);
    map.setView([39.5, -98.5], 4); // default USA view so you see a map even if CSV fails

    // Cluster group (feel free to tweak disableClusteringAtZoom)
    const clusters = L.markerClusterGroup({
      showCoverageOnHover: false,
      spiderfyOnMaxZoom: true,
      disableClusteringAtZoom: 10
    }).addTo(map);

    // Cluster hover: if all child markers share one resort, show the resort; else show count
    clusters.on("clustermouseover", (e) => {
      try {
        const children = e.layer.getAllChildMarkers();
        const resorts = Array.from(new Set(children.map(m => m.options._resort).filter(Boolean)));
        const text = (resorts.length === 1) ? resorts[0] : `${children.length} courses`;
        e.layer.bindTooltip(text, { direction: "top", offset: [0, -8] }).openTooltip();
      } catch {}
    });
    clusters.on("clustermouseout", (e) => {
      if (e.layer.getTooltip()) e.layer.closeTooltip();
    });

    // CSV loading
    const csvUrl = getParam("csv");
    if (!csvUrl) {
      console.warn("No ?csv= URL provided. Add ?csv=<encoded csv url> to your page URL.");
    } else {
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: ({ data }) => {
          if (!Array.isArray(data) || data.length === 0) {
            console.warn("CSV loaded but empty.");
            return;
          }

          const bounds = L.latLngBounds();
          let plotted = 0;

          data.forEach((r) => {
            // Flexible lat/lon column names
            const lat = r.Latitude ?? r.latitude ?? r.lat;
            const lon = r.Longitude ?? r.longitude ?? r.lng ?? r.lon;
            const latN = num(lat), lonN = num(lon);
            if (!isFinite(latN) || !isFinite(lonN)) return;

            // Pull fields from your CSV
            const name       = val(r["Course Name"] || r.name);
            const resort     = val(r["Course Resort"]);
            const city       = val(r["City"]);
            const state      = val(r["State/Province"]);
            const par        = val(r["Par"]);
            const yardage    = val(r["Yardage (Back Tees)"]);
            const arch       = val(r["Architect(s)"]);
            const year       = val(r["Year Opened"]);
            const fees       = val(r["Cost per Course (Green Fee Range)"]);
            const walking    = val(r["Walking Friendly (Yes/No)"]);
            const caddie     = val(r["Caddie/Cart Policy"]);
            const practice   = val(r["Practice Facilities (Range/Short Game)"]);
            const dining     = val(r["On-site Dining (Notes)"]);
            const lodgingYN  = val(r["Lodging On-Site (Yes/No)"]);
            const lodgingDet = val(r["Lodging Details & Typical Price"]);
            const airports   = val(r["Nearby Airports (Distance)"]);
            const website    = val(r["Website URL"]);
            const phone      = val(r["Phone"]);
            const ranking    = val(r["Ranking (Consensus or Golf Digest Top 100)"]);

            // Popup HTML (polished)
            const courseLine = [par && `Par ${par}`, yardage && `${yardage} yds`]
              .filter(Boolean).join(" • ");

            const lines = [];
            if (courseLine) lines.push(`<div><b>Course:</b> ${courseLine}</div>`);
            if (arch)       lines.push(`<div><b>Architect(s):</b> ${arch}</div>`);
            if (year)       lines.push(`<div><b>Year Opened:</b> ${year}</div>`);
            if (ranking)    lines.push(`<div><b>Ranking:</b> ${ranking}</div>`);
            if (fees)       lines.push(`<div><b>Fees:</b> ${fees}</div>`);
            if (walking)    lines.push(`<div><b>Walking:</b> ${walking}</div>`);
            if (caddie)     lines.push(`<div><b>Caddie/Cart:</b> ${caddie}</div>`);
            if (practice)   lines.push(`<div><b>Practice:</b> ${practice}</div>`);
            if (dining)     lines.push(`<div><b>Dining:</b> ${dining}</div>`);
            if (lodgingYN || lodgingDet) {
              lines.push(`<div><b>Lodging:</b> ${[lodgingYN, lodgingDet].filter(Boolean).join(" — ")}</div>`);
            }
            if (airports)   lines.push(`<div><b>Airports:</b> ${airports}</div>`);
            if (website)    lines.push(`<div style="margin-top:6px"><a href="${website}" target="_blank" rel="noopener">Website</a></div>`);
            if (phone)      lines.push(`<div>${phone}</div>`);

            const popupHtml = `
              <div style="min-width:260px; max-width:360px;">
                <div style="font-weight:700">${name || "Unknown"}</div>
                ${resort ? `<div style="color:#444"><em>${resort}</em></div>` : ``}
                <div style="margin:6px 0 8px 0; color:#333">
                  ${[city, state].filter(Boolean).join(", ")}
                </div>
                <div style="font-size:13px; line-height:1.35; max-height:260px; overflow:auto; padding-right:4px;">
                  ${lines.join("")}
                </div>
              </div>
            `;

            // Create marker with resort stored for cluster tooltip logic
            const marker = L.marker([latN, lonN], { _resort: resort })
              .bindPopup(popupHtml);

            // Hover tooltip on individual markers: show course name
            if (name) marker.bindTooltip(name, { direction: "top", offset: [0, -8] });

            clusters.addLayer(marker);
            bounds.extend([latN, lonN]);
            plotted++;
          });

          if (plotted > 0) {
            map.fitBounds(bounds.pad(0.15));
          } else {
            console.warn("CSV loaded but no valid Latitude/Longitude found.");
          }
        },
        error: (e) => {
          console.error("CSV load error:", e);
          alert("Could not load CSV. Open DevTools → Console for details.");
        }
      });
    }

    // Debug toggle: add &debug=1 to URL
    if (getParam("debug") === "1") console.log("Debug ON:", location.href);
  </script>
</body>
</html>
