<!DOCTYPE html>


function makeMarker(r){
let lat=toNum(r.latitude??r.Latitude??r.lat);
let lon=toNum(r.longitude??r.Longitude??r.lon??r.lng);
if(!Number.isFinite(lat)||!Number.isFinite(lon)) return null;
[lat,lon]=hawaiiTuck(lat,lon);


const title=r["course_name"]||r["Course Name"]||r["course name"]||r["name"]||"";
const m=L.marker([lat,lon],{icon:courseIcon,title});


// Popup with generous autopan padding (keeps it clear of left controls & top search)
m.bindPopup(()=>popupHtml(r),{
maxWidth:380,minWidth:260,closeButton:true,autoPan:true,
autoPanPaddingTopLeft: L.point(140,120), // space for controls/search
autoPanPaddingBottomRight: L.point(20,20)
});
m.bindTooltip(title,{direction:"top",offset:[0,-12],opacity:.92,className:"ga-tooltip"});


const rank=r["top_100_ranking"]||r["top 100 ranking"]||r["ranking"]||r["rank"]||"";
m.on("add",()=>{ if(isTop100(rank)&&m._icon){ m._icon.style.filter="drop-shadow(0 0 1px #b9902d) drop-shadow(0 0 6px rgba(185,144,45,.55))"; } });


// ✅ On mobile, center to the tap point (helps when keyboard/UI shifts viewport)
m.on("click",(ev)=>{ if(isMobile){ map.setView(ev.latlng, Math.max(map.getZoom(), 12), {animate:true}); } });


m.on("mouseover",()=>m.setZIndexOffset(1000));
m.on("mouseout", ()=>m.setZIndexOffset(0));


rowByMarker.set(m,r);
return m;
}


Papa.parse(CSV_URL,{
download:true,header:true,skipEmptyLines:true,
complete: res=>{
const rows=res.data||[], names=new Set();
rows.forEach(r=>{
const m=makeMarker(r); if(!m) return;
markers.push({marker:m,row:r}); rowByMarker.set(m,r);
clusterLayer.addLayer(m);
const nm=r["course_name"]||r["Course Name"]||r["course name"]||r["name"]; if(nm) names.add(nm);
});
const dl=document.getElementById("courseList"); dl.innerHTML="";
Array.from(names).filter(Boolean).sort().slice(0,2000).forEach(n=>{const o=document.createElement("option");o.value=n;dl.appendChild(o);});
if(markers.length){const g=L.featureGroup(markers.map(m=>m.marker)); map.fitBounds(g.getBounds().pad(0.08),{animate:true});}
},
error: err=>{console.error("CSV load error:",err); alert("Error loading data CSV. Check ?csv= link and that it’s published as CSV.");}
});


/* ===== Filters & search clear ===== */
function applyFilters(){
const topOnly=document.getElementById("top100Toggle").checked;
const q=(document.getElementById("searchBox").value||"").toLowerCase();
clusterLayer.clearLayers();
markers.forEach(({marker,row})=>{
const rank=row["top_100_ranking"]||row["top 100 ranking"]||row["ranking"]||row["rank"]||"";
const name=(row["course_name"]||row["Course Name"]||row["course name"]||row["name"]||"").toLowerCase();
const city=(row["City"]||row["city"]||"").toLowerCase();
const state=(row["state"]||row["State"]||"").toLowerCase();
const okTop=!topOnly||isTop100(rank);
const okSearch=!q||(name.includes(q)||city.includes(q)||state.includes(q));
if(okTop&&okSearch){ clusterLayer.addLayer(marker); }
});
}
document.getElementById("top100Toggle").addEventListener("change", applyFilters);
const searchBox=document.getElementById("searchBox");
const searchWrap=document.getElementById("searchWrapper");
const clearBtn=document.getElementById("clearSearch");
function updateClear(){searchWrap.classList.toggle("has-text", !!searchBox.value);}
searchBox.addEventListener("input", ()=>{updateClear();applyFilters();});
searchBox.addEventListener("keydown", e=>{if(e.key==="Enter"){e.preventDefault();applyFilters();}});
clearBtn.addEventListener("click", ()=>{searchBox.value="";updateClear();applyFilters();});


/* ===== Cluster hover tooltip with resort names ===== */
clusterLayer.on("clustermouseover",(e)=>{
const counts=new Map();
e.layer.getAllChildMarkers().forEach(m=>{
const row=rowByMarker.get(m)||{};
const nm=(row["course_resort"]||row["course resort"]||row["resort"]||"").trim();
if(nm) counts.set(nm,(counts.get(nm)||0)+1);
});
let text="";
if(counts.size===1){ text=[...counts.keys()][0]; }
else if(counts.size>1){
const parts=[...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3).map(([n,c])=>`${n} (${c})`);
text=parts.join(", "); if(counts.size>3) text+=" …";
} else { text=`${e.layer.getChildCount()} courses`; }
e.layer.bindTooltip(text,{className:"ga-tooltip",direction:"top",offset:[0,-2],opacity:.95}).openTooltip();
});
clusterLayer.on("clustermouseout", e=>e.layer.closeTooltip());
</script>
</body>
</html>
